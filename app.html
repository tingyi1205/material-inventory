<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å¤šç‰©æ–™å®‰å…¨åº«å­˜é æ¸¬ï¼ˆFirebase é›²ç«¯åŒæ­¥ç‰ˆï¼‰</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, get, child, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCqrJLgSjcfkMLjwkyrjxYQ7oVOdg6RIGc",
      authDomain: "project-1717180986868719433.firebaseapp.com",
      projectId: "project-1717180986868719433",
      storageBucket: "project-1717180986868719433.firebasestorage.app",
      messagingSenderId: "733817764256",
      appId: "1:733817764256:web:eeff83e905eed8958d8cc5",
      measurementId: "G-NLG6XVDBEC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const materialSelect = document.getElementById("materialSelect");
    const materialTable = document.querySelector("#materialTable tbody");

    function updateMaterialSelect(data) {
      materialSelect.innerHTML = '<option disabled selected>è«‹é¸æ“‡</option>';
      for (const key in data) {
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = key;
        materialSelect.appendChild(opt);
      }
    }

    function updateMaterialTable(data) {
      materialTable.innerHTML = "";
      for (const [name, d] of Object.entries(data)) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${name}</td>
          <td>${d.stock}</td>
          <td>${d.usage}</td>
          <td>${d.period}</td>
          <td>${d.z}</td>
        `;
        materialTable.appendChild(tr);
      }
    }

    function loadFromFirebase() {
      const dbRef = ref(db);
      onValue(child(dbRef, 'materials'), (snapshot) => {
        const data = snapshot.val() || {};
        window.materialData = data;
        updateMaterialSelect(data);
        updateMaterialTable(data);
      });
    }

    document.getElementById("addMaterial").addEventListener("click", () => {
      const name = document.getElementById("newName").value.trim();
      const stock = parseFloat(document.getElementById("newStock").value);
      const usage = parseFloat(document.getElementById("newUsage").value);
      const period = parseFloat(document.getElementById("newPeriod").value);
      const z = parseFloat(document.getElementById("newZ").value);

      if (!name || isNaN(stock) || isNaN(usage) || isNaN(period) || isNaN(z)) {
        alert("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½");
        return;
      }

      set(ref(db, `materials/${name}`), { stock, usage, period, z })
        .then(() => alert(`å·²æ–°å¢ã€Œ${name}ã€ï¼`))
        .catch(console.error);
    });

    document.getElementById("deleteMaterial").addEventListener("click", () => {
      const selected = materialSelect.value;
      if (!selected) return alert("è«‹å…ˆé¸æ“‡ç‰©æ–™");
      if (confirm(`ç¢ºå®šåˆªé™¤ã€Œ${selected}ã€ï¼Ÿ`)) {
        remove(ref(db, `materials/${selected}`))
          .then(() => alert(`å·²åˆªé™¤ã€Œ${selected}ã€`))
          .catch(console.error);
      }
    });

    materialSelect.addEventListener("change", () => {
      const d = window.materialData[materialSelect.value];
      if (d) {
        document.getElementById("currentStock").value = d.stock;
        document.getElementById("dailyUsage").value = d.usage;
        document.getElementById("orderPeriod").value = d.period;
        document.getElementById("safetyFactor").value = d.z;
      }
    });

    document.getElementById("stockForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const stock = parseFloat(document.getElementById("currentStock").value);
      const usage = parseFloat(document.getElementById("dailyUsage").value);
      const period = parseFloat(document.getElementById("orderPeriod").value);
      const z = parseFloat(document.getElementById("safetyFactor").value);
      const demand = usage * period;
      const safetyStock = z * usage * Math.sqrt(period);
      const suggestion = Math.ceil(demand + safetyStock - stock);
      document.getElementById("demand").innerText = demand.toFixed(2);
      document.getElementById("safetyStock").innerText = safetyStock.toFixed(2);
      document.getElementById("suggestion").innerText = suggestion > 0 ? suggestion : "ä¸éœ€è£œè²¨";
      document.getElementById("resultBox").style.display = "block";
    });

    loadFromFirebase();
  </script>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">ğŸ“¦ å¤šç‰©æ–™å®‰å…¨åº«å­˜é æ¸¬ç³»çµ±</h2>

    <!-- ğŸ”½ é¸æ“‡ç‰©æ–™ -->
    <div class="mb-3">
      <label for="materialSelect" class="form-label">é¸æ“‡ç‰©æ–™</label>
      <select id="materialSelect" class="form-select">
        <option value="" disabled selected>è«‹é¸æ“‡</option>
      </select>
    </div>

    <!-- âœï¸ æ–°å¢ç‰©æ–™ -->
    <div class="border p-3 mb-4">
      <h5>â• æ–°å¢ç‰©æ–™</h5>
      <div class="row g-2">
        <div class="col-md-3"><input type="text" id="newName" class="form-control" placeholder="ç‰©æ–™åç¨±"></div>
        <div class="col-md-2"><input type="number" id="newStock" class="form-control" placeholder="åº«å­˜"></div>
        <div class="col-md-2"><input type="number" id="newUsage" class="form-control" placeholder="æ¯æ—¥æ¶ˆè€—"></div>
        <div class="col-md-2"><input type="number" id="newPeriod" class="form-control" placeholder="é€±æœŸï¼ˆå¤©ï¼‰"></div>
        <div class="col-md-2"><input type="number" step="0.01" id="newZ" class="form-control" placeholder="Z å€¼"></div>
        <div class="col-md-1"><button id="addMaterial" class="btn btn-success w-100">æ–°å¢</button></div>
      </div>
    </div>

    <!-- ğŸ“‹ é æ¸¬è¼¸å…¥å€ -->
    <form id="stockForm">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">ç›®å‰åº«å­˜</label>
          <input type="number" id="currentStock" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">æ¯æ—¥å¹³å‡æ¶ˆè€—é‡</label>
          <input type="number" id="dailyUsage" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">è¨‚è³¼é€±æœŸï¼ˆå¤©ï¼‰</label>
          <input type="number" id="orderPeriod" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">å®‰å…¨ä¿‚æ•¸ï¼ˆZ å€¼ï¼‰</label>
          <input type="number" step="0.01" id="safetyFactor" class="form-control" value="1.65">
        </div>
      </div>
      <button type="submit" class="btn btn-primary mt-4">è¨ˆç®—å»ºè­°è£œè²¨é‡</button>
    </form>

    <!-- ğŸ“Š çµæœå€ -->
    <div class="result-box mt-5" id="resultBox" style="display: none;">
      <h4>ğŸ“Š è¨ˆç®—çµæœ</h4>
      <p><strong>é ä¼°éœ€æ±‚é‡ï¼š</strong> <span id="demand"></span></p>
      <p><strong>å®‰å…¨åº«å­˜é‡ï¼š</strong> <span id="safetyStock"></span></p>
      <p><strong>å»ºè­°è£œè²¨æ•¸é‡ï¼š</strong> <span id="suggestion"></span></p>
    </div>
  </div>

  <script>
    // å…§å»ºè³‡æ–™
    const defaultData = {
      "èºçµ² M4": { stock: 120, usage: 10, period: 7, z: 1.65 },
      "é›»é˜» 1KÎ©": { stock: 300, usage: 20, period: 10, z: 1.65 },
      "éŠ…æŸ± 5mm": { stock: 80, usage: 5, period: 14, z: 1.65 },
    };

    // å„²å­˜ç”¨çš„ç‰©æ–™è¡¨
    let materialData = {};

    // åˆå§‹åŒ–ï¼šè®€å– localStorage
    function loadMaterialData() {
      const saved = localStorage.getItem("materialData");
      materialData = saved ? JSON.parse(saved) : { ...defaultData };
      updateSelectOptions();
    }

    // æ›´æ–°é¸å–®é¸é …
    function updateSelectOptions() {
      const select = document.getElementById("materialSelect");
      select.innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡</option>`;
      Object.keys(materialData).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
    }

    // é¸æ“‡ç‰©æ–™ â†’ è‡ªå‹•å¡«å…¥æ•¸å€¼
    document.getElementById("materialSelect").addEventListener("change", function () {
      const selected = this.value;
      const data = materialData[selected];
      if (data) {
        document.getElementById("currentStock").value = data.stock;
        document.getElementById("dailyUsage").value = data.usage;
        document.getElementById("orderPeriod").value = data.period;
        document.getElementById("safetyFactor").value = data.z;
      }
    });

    // æ–°å¢ç‰©æ–™æŒ‰éˆ•
    document.getElementById("addMaterial").addEventListener("click", function () {
      const name = document.getElementById("newName").value.trim();
      const stock = parseFloat(document.getElementById("newStock").value);
      const usage = parseFloat(document.getElementById("newUsage").value);
      const period = parseFloat(document.getElementById("newPeriod").value);
      const z = parseFloat(document.getElementById("newZ").value);

      if (!name || isNaN(stock) || isNaN(usage) || isNaN(period) || isNaN(z)) {
        alert("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½");
        return;
      }

      materialData[name] = { stock, usage, period, z };
      localStorage.setItem("materialData", JSON.stringify(materialData));
      updateSelectOptions();
      alert(`å·²æ–°å¢ã€Œ${name}ã€åˆ°ç‰©æ–™æ¸…å–®ï¼`);

      // æ¸…ç©ºè¼¸å…¥æ¬„ä½
      document.getElementById("newName").value = "";
      document.getElementById("newStock").value = "";
      document.getElementById("newUsage").value = "";
      document.getElementById("newPeriod").value = "";
      document.getElementById("newZ").value = "";
    });

    // è¨ˆç®—è£œè²¨é‡
    document.getElementById("stockForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const stock = parseFloat(document.getElementById("currentStock").value);
      const usage = parseFloat(document.getElementById("dailyUsage").value);
      const period = parseFloat(document.getElementById("orderPeriod").value);
      const z = parseFloat(document.getElementById("safetyFactor").value);

      const demand = usage * period;
      const safetyStock = z * usage * Math.sqrt(period);
      const suggestion = Math.ceil(demand + safetyStock - stock);

      document.getElementById("demand").innerText = demand.toFixed(2);
      document.getElementById("safetyStock").innerText = safetyStock.toFixed(2);
      document.getElementById("suggestion").innerText = suggestion > 0 ? suggestion : "ä¸éœ€è£œè²¨";

      document.getElementById("resultBox").style.display = "block";
    });

    // åˆå§‹åŸ·è¡Œ
    loadMaterialData();
  </script>
</body>
</html>
